runOn:
  - minServerVersion: "6.0.0"
database_name: &database_name "default"
collection_name: &collection_name "default"

data: []

key_vault_data: [
  {
    "_id": {
        "$binary": {
            # Hex of _id is: ABCDEFAB123498761234123456789012
            "base64": "q83vqxI0mHYSNBI0VniQEg==",
            "subType": "04"
        },
    },
    "keyMaterial": {
        "$binary": {
            "base64": "HBk9BWihXExNDvTp1lUxOuxuZK2Pe2ZdVdlsxPEBkiO1bS4mG5NNDsQ7zVxJAH8BtdOYp72Ku4Y3nwc0BUpIKsvAKX4eYXtlhv5zUQxWdeNFhg9qK7qb8nqhnnLeT0f25jFSqzWJoT379hfwDeu0bebJHr35QrJ8myZdPMTEDYF08QYQ48ShRBli0S+QzBHHAQiM2iJNr4svg2WR8JSeWQ==",
            "subType": "00"
        }
    },
    "creationDate": {
        "$date": {
            "$numberLong": "1648914851981"
        }
    },
    "updateDate": {
        "$date": {
            "$numberLong": "1648914851981"
        }
    },
    "status": {
        "$numberInt": "0"
    },
    "masterKey": {
        "provider": "local"
    }
  }
]

tests:
  - description: "default state collections are applied to encryptionInformation"
    clientOptions:
      autoEncryptOpts:
        kmsProviders:
          local: {
            "key": {
              "$binary": {
                "base64": "Mng0NCt4ZHVUYUJCa1kxNkVyNUR1QURhZ2h2UzR2d2RrZzh0cFBwM3R6NmdWMDFBMUN3YkQ5aXRRMkhGRGdQV09wOGVNYUMxT2k3NjZKelhaQmRCZGJkTXVyZG9uSjFk",
                "subType": "00"
              }
            }
          }
        encryptedFieldsMap: &efm {
          "default.default": {
            "fields": []
          }
        }
    operations:
      # EncryptedFieldsMap overrides remote encryptedFields.
      # Automatic encryption does not occur on encryptedUnindexed. The value is validated on the server.
      - name: insertOne
        arguments:
          document: &doc0 {
            _id: 1,
            foo: "bar"
          }
    expectations:
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - *doc0
            encryptionInformation: {
                "type": {
                    "$numberInt": "1"
                },
                "schema": {
                    "default.default": {
                        "fields": [],
                        "escCollection": "enxcol_.default.esc",
                        "eccCollection": "enxcol_.default.ecc",
                        "ecocCollection": "enxcol_.default.ecoc"
                    }
                }
              }
            ordered: true
          command_name: insert
    outcome:
      collection:
        # Outcome is checked using a separate MongoClient without auto encryption.
        data:
          - *doc0