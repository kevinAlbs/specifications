description: "client-bulkWrite"

schemaVersion: "1.0"

createEntities:
  - client:
      id: &client client
      observeEvents:
        - commandStartedEvent
        - commandSucceededEvent
        - commandFailedEvent
  - database:
      id: &database database
      client: *client
      databaseName: &databaseName command-monitoring-tests
  - collection:
      id: &collection collection
      database: *database
      collectionName: &collectionName test

initialData:
  - collectionName: *collectionName
    databaseName: *databaseName
    documents:
      - { _id: 1, x: 11 }
      - { _id: 2, x: 22 }
      - { _id: 3, x: 33 }

_yamlAnchors:
  namespace: &namespace "command-monitoring-tests.test"

tests:
  - description: 'A successful mixed client bulkWrite'
    operations:
      - object: *client
        name: clientBulkWrite
        arguments:
          models:
            - insertOne:
                namespace: *namespace
                document: { _id: 4, x: 44 }
            - updateOne:
                namespace: *namespace
                filter: { _id: 3 }
                update: { $set: { x: 333 } }
        expectResult:
          insertedCount: 1
          upsertedCount: 0
          matchedCount: 1
          modifiedCount: 1
          deletedCount: 0
          insertResults:
            $$unsetOrMatches: {}
          updateResults:
            $$unsetOrMatches: {}
          deleteResults:
            $$unsetOrMatches: {}
    expectEvents:
      -
        client: *client
        events:
          - commandStartedEvent:
              commandName: bulkWrite
              databaseName: admin
              command:
                bulkWrite: 1
                errorsOnly: true
                ordered: true
                ops:
                  - insert: 0
                    document: { _id: 4, x: 44 }
                  - update: 0
                    filter: { _id: 3 }
                    updateMods: { $set: { x: 333 } }
                    multi: false
                nsInfo:
                  - ns: *namespace
          - commandSucceededEvent:
              commandName: bulkWrite
              reply:
                ok: 1
                nInserted: 1
                nMatched: 1
                nModified: 1
                nUpserted: 0
                nDeleted: 0
