data:
  - _id: 1
    x: 11
  - _id: 2
    x: 22
collection_name: default_write_concern_coll
database_name: default_write_concern_db
tests:
  - description: Aggregate with $merge
    operations:
      - object: collection
        name: aggregate
        arguments:
          pipeline: &ref_0
            - $match:
                _id:
                  $gt: 1
            - $merge:
                into: other_test_collection
    expectations:
      - command_started_event:
          command:
            aggregate: default_write_concern_coll
            pipeline: *ref_0
            writeConcern: null
    outcome:
      collection:
        name: other_test_collection
        data:
          - _id: 2
            x: 22
  - description: Aggregate with $out
    operations:
      - object: collection
        name: aggregate
        arguments:
          pipeline: &ref_1
            - $match:
                _id:
                  $gt: 1
            - $out: other_test_collection
          batchSize: 2
    outcome:
      collection:
        name: other_test_collection
        data:
          - _id: 2
            x: 22
    expectations:
      - command_started_event:
          command:
            aggregate: default_write_concern_coll
            pipeline: *ref_1
            writeConcern: null
  - description: runCommand with a write command
    operations:
      - object: database
        name: runCommand
        arguments:
          command:
            create: test_collection
    expectations:
      - command_started_event:
          command:
            create: test_collection
            writeConcern: null
  - description: create and drop index
    operations:
      - object: collection
        name: createIndex
        arguments:
          model:
            x: 1
      - object: collection
        name: dropIndex
        arguments:
          name: _x_1
    expectations:
      - command_started_event:
          command:
            createIndexes: default_write_concern_coll
            indexes:
              - name: _x_1
                key:
                  x: 1
            writeConcern: null
      - command_started_event:
          command:
            dropIndexes: default_write_concern_coll
            index: _x_1
            writeConcern: null
  - description: delete one
    operations:
      - name: deleteOne
        object: collection
        arguments:
          filter: {}
        result:
          deletedCount: 1
    expectations:
      - command_started_event:
          command:
            delete: default_write_concern_coll
            deletes:
              - q: {}
                limit: 1
            writeConcern: null
  - description: delete many
    operations:
      - name: deleteMany
        object: collection
        arguments:
          filter: {}
        result:
          deletedCount: 2
    expectations:
      - command_started_event:
          command:
            delete: default_write_concern_coll
            deletes:
              - q: {}
                limit: 0
            writeConcern: null
  - description: bulk write with all models
    operations:
      - name: bulkWrite
        object: collection
        arguments:
          ordered: true
          requests:
            - name: deleteMany
              arguments:
                filter: {}
            - name: insertOne
              arguments:
                document:
                  _id: 1
            - name: updateOne
              arguments:
                filter:
                  _id: 1
                update:
                  $set:
                    x: 1
            - name: insertOne
              arguments:
                document:
                  _id: 2
            - name: replaceOne
              arguments:
                filter:
                  _id: 1
                replacement:
                  x: 2
            - name: insertOne
              arguments:
                document:
                  _id: 3
            - name: updateMany
              arguments:
                filter:
                  _id: 1
                update:
                  $set:
                    x: 3
            - name: deleteOne
              arguments:
                filter:
                  _id: 3
    outcome:
      collection:
        name: default_write_concern_coll
        data:
          - _id: 1
            x: 3
          - _id: 2
    expectations:
      - command_started_event:
          command:
            delete: default_write_concern_coll
            deletes:
              - q: {}
                limit: 0
            writeConcern: null
      - command_started_event:
          command:
            insert: default_write_concern_coll
            documents:
              - _id: 1
            writeConcern: null
      - command_started_event:
          command:
            update: default_write_concern_coll
            updates:
              - q:
                  _id: 1
                u:
                  $set:
                    x: 1
            writeConcern: null
      - command_started_event:
          command:
            insert: default_write_concern_coll
            documents:
              - _id: 2
            writeConcern: null
      - command_started_event:
          command:
            update: default_write_concern_coll
            updates:
              - q:
                  _id: 1
                u:
                  x: 2
            writeConcern: null
      - command_started_event:
          command:
            insert: default_write_concern_coll
            documents:
              - _id: 3
            writeConcern: null
      - command_started_event:
          command:
            update: default_write_concern_coll
            updates:
              - q:
                  _id: 1
                u:
                  $set:
                    x: 3
                multi: true
            writeConcern: null
      - command_started_event:
          command:
            delete: default_write_concern_coll
            deletes:
              - q:
                  _id: 3
                limit: 1
            writeConcern: null
  - description: 'findOneAnd{update,delete,replace}'
    operations:
      - name: findOneAndUpdate
        arguments:
          filter:
            _id: 1
          update:
            $set:
              x: 1
      - name: findOneAndReplace
        arguments:
          filter:
            _id: 2
          replacement:
            x: 2
      - name: findOneAndDelete
        arguments:
          filter:
            _id: 2
    outcome:
      collection:
        name: default_write_concern_coll
        data:
          - _id: 1
            x: 1
    expectations:
      - command_started_event:
          command:
            findAndModify: default_write_concern_coll
            query:
              _id: 1
            update:
              $set:
                x: 1
            writeConcern: null
      - command_started_event:
          command:
            findAndModify: default_write_concern_coll
            query:
              _id: 2
            update:
              x: 2
            writeConcern: null
      - command_started_event:
          command:
            findAndModify: default_write_concern_coll
            query:
              _id: 2
            remove: true
            writeConcern: null
  - description: 'insert{one,many}'
    operations:
      - name: insertOne
        arguments:
          document:
            _id: 3
      - name: insertMany
        arguments:
          documents:
            - _id: 4
            - _id: 5
    outcome:
      collection:
        name: default_write_concern_coll
        data:
          - _id: 1
            x: 11
          - _id: 2
            x: 22
          - _id: 3
          - _id: 4
          - _id: 5
    expectations:
      - command_started_event:
          command:
            insert: default_write_concern_coll
            documents:
              - _id: 3
            writeConcern: null
      - command_started_event:
          command:
            insert: default_write_concern_coll
            documents:
              - _id: 4
              - _id: 5
            writeConcern: null
  - description: mapReduce
    operations:
      - name: mapReduce
        object: collection
        arguments:
          map:
            $code: 'function inc() { return emit(0, this.x + 1) }'
          reduce:
            $code: >-
              function sum(key, values) { return values.reduce((acc, x) => acc +
              x); }
          out:
            inline: 1
    expectations:
      - command_started_event:
          command:
            mapReduce: default_write_concern_coll
            map:
              $code: 'function inc() { return emit(0, this.x + 1) }'
            reduce:
              $code: >-
                function sum(key, values) { return values.reduce((acc, x) => acc
                + x); }
            out:
              inline: 1
            writeConcern: null
  - description: 'update{one,many} replaceOne'
    operations:
      - name: updateOne
        arguments:
          filter:
            _id: 1
          update:
            $set:
              x: 1
      - name: updateMany
        arguments:
          filter:
            _id: 2
          update:
            $set:
              x: 2
      - name: replaceOne
        arguments:
          filter:
            _id: 2
          replacement:
            x: 3
    outcome:
      collection:
        name: default_write_concern_coll
        data:
          - _id: 1
            x: 1
          - _id: 2
            x: 3
    expectations:
      - command_started_event:
          command:
            update: default_write_concern_coll
            updates:
              - q:
                  _id: 1
                u:
                  $set:
                    x: 1
            writeConcern: null
      - command_started_event:
          command:
            update: default_write_concern_coll
            updates:
              - q:
                  _id: 2
                u:
                  $set:
                    x: 2
                multi: true
            writeConcern: null
      - command_started_event:
          command:
            update: default_write_concern_coll
            updates:
              - q:
                  _id: 2
                u:
                  x: 3
            writeConcern: null